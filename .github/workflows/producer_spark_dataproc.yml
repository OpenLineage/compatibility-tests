name: Spark Dataplex
on: workflow_call

jobs:
  do-something:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: get latest OL tag
        id: latest_ol_tag
        run: echo "ol_version=$(curl https://api.github.com/repos/OpenLineage/OpenLineage/releases/latest -s | jq .tag_name -r)" >> $GITHUB_OUTPUT

      - name: Get OL artifacts
        id: get_ol_artifacts
        uses: ./.github/actions/get_openlineage_artifacts
        with:
          version: ${{ steps.latest_ol_tag.outputs.ol_version }}

      - name: Run producer and create events
        id: run-producer
        run: echo "THIS SHOULD RUN THE PRODUCER TESTS AND ALL BUT NOW IT DOES NOTHING"

      - name: Syntax Validation
        uses: ./.github/actions/run_syntax_validation
        with:
          component: 'Spark Dataproc'
          version: ${{ steps.latest_ol_tag.outputs.ol_version }}
          target-path: ${{ report/spark-dataproc-report.json}}


      - name: Set up Python 3.11
        uses: actions/setup-python@v3
        with:
          python-version: "3.11"

      - name: create dir for ol spec
        id: dir_for_spec
        run: mkdir -p spec

      - name: get latest OL spec
        uses: actions/checkout@v4
        with:
          repository: OpenLineage/OpenLineage
          ref: ${{ steps.latest_ol_tag.outputs.ol_version }}
          path: spec
          sparse-checkout: |
            spec/

      - name: list files
        run: |
          echo "BASE LEVEL FILES\n"
          ls 
          echo "FILES IN spec/ \n"
          ls spec
          echo "END \n"

      - name: Validate OpenLineage events
        run: |
          pip install jsonschema
          python scripts/validate_schemas.py \
          --event_base_dir=events \
          --spec_dirs=spec/spec/,spec/spec/facets/,spec/spec/registry/gcp/dataproc/facets,spec/spec/registry/gcp/lineage/facets \
          --target=report.json \
          --component=Spark
          
