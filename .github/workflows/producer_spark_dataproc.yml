name: Spark Dataproc

on: workflow_call

jobs:
  do-something:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: get latest OL tag
        id: latest_ol_tag
        run: echo "ol_version=$(curl https://api.github.com/repos/OpenLineage/OpenLineage/releases/latest -s | jq .tag_name -r)" >> $GITHUB_OUTPUT

      - name: Get OL artifacts
        id: get_ol_artifacts
        uses: ./.github/actions/get_openlineage_artifacts
        with:
          version: ${{ steps.latest_ol_tag.outputs.ol_version }}
          skip-flink: 'true'
          skip-s3: 'true'
          skip-gcp-lineage: 'true'
          skip-sql: 'true'

      - name: Get unreleased OL artifacts
        id: get-unreleased
        uses: ./.github/actions/get_unreleased_openlineage_artifacts
        with:
          version: ${{ steps.latest_ol_tag.outputs.ol_version }}

      - name: Run producer and create events
        id: run-producer
        run: echo "THIS SHOULD RUN THE PRODUCER TESTS AND ALL BUT NOW IT DOES NOTHING"

      - name: set producer output event dir
        id: set-producer-output
        run: echo "event_dir=./events" >> $GITHUB_OUTPUT

      - name: Validation
        uses: ./.github/actions/run_event_validation
        with:
          component: 'Spark Dataproc'
          version: ${{ steps.latest_ol_tag.outputs.ol_version }}
          event-directory: ${{ steps.set-producer-output.event_dir }}
          target-path: 'spark-dataproc-report.json'

      - uses: actions/upload-artifact@v4
        with:
          name: spark-dataproc-report
          path: spark-dataproc-report.json
          retention-days: 1


          
